# CLAUDE.md

This file gives Claude (and other AI assistants) the context needed to work effectively in this repository.

## Package Overview

**plot2** is a high-level R wrapper around `ggplot2` designed to minimise typing while producing complex, publication-ready plots. The central idea: one call to `plot2()` replaces many separate `ggplot2` + `dplyr`/`tidyr` steps, including automatic plot-type selection, in-line data transformations, axis handling, and custom theming.

- CRAN/GitHub: <https://github.com/msberends/plot2>
- Docs site: <https://msberends.github.io/plot2>
- License: GPL-2
- Requires R ≥ 4.1.0, ggplot2 ≥ 4.0.0

---

## Repository Layout

```
plot2/
├── R/                        # All package source (one concern per file)
│   ├── plot2.R               # Core plot2() function and its roxygen docs (~2 270 lines)
│   ├── plot2-methods.R       # S3 methods: .data.frame, .matrix, .sf, .freq, .lm, .formula
│   ├── validate.R            # validate_type(), validate_legend.position(), etc.
│   ├── utils.R               # plot2_env, globalVariables(), like(), %like%, %unlike%
│   ├── get_colour.R          # colour S3 class, get_colour(), register_colour()
│   ├── theme_minimal2.R      # theme_minimal2() and font helpers
│   ├── shiny.R               # create_interactively() Shiny app
│   ├── options.R             # Package-level option docs (plot2-options)
│   ├── format2.R             # format2() with S3 methods for Date/POSIXt/numeric/etc.
│   ├── md_to_expression.R    # Markdown → R expression for plot titles/labels
│   ├── add_mapping.R         # add_*() layer helpers
│   ├── add_type.R            # add_type() internals
│   ├── back2back_plot.R      # Back-to-back / tornado plot implementation
│   ├── coord_spider.R        # CoordSpider novel coordinate system
│   ├── data.R                # Documentation for bundled datasets
│   ├── dec_mark.R            # dec_mark(), big_mark(), dollars(), euros()
│   ├── get_plot_title.R      # Title extraction helpers
│   ├── labellers.R           # Custom ggplot2 labeller functions
│   ├── move_layer.R          # move_layer() utility
│   ├── plotly.R              # plotly integration
│   ├── reexports.R           # Re-exported dplyr / tidyselect functions
│   └── aa_pkg.R              # Package-level @import declarations
├── tests/testthat/
│   └── test_plot2.R          # All tests in a single file
├── vignettes/
│   ├── plot2.Rmd             # Main vignette (comprehensive examples)
│   └── supported_types.Rmd   # Guide to all supported plot types
├── data/                     # Bundled .rda datasets (admitted_patients, netherlands)
├── data-raw/                 # Scripts that produced data/
├── man/                      # Auto-generated by roxygen2 – never edit manually
├── inst/                     # Installed files (fonts, etc.)
├── .github/workflows/
│   ├── check.yaml            # R CMD check across 7 OS/R-version combinations
│   ├── website.yaml          # pkgdown site deployment
│   └── check_dev_versions.yaml
├── _pkgdown.yml              # pkgdown config (Bootstrap 5, "united" theme)
├── codecov.yml               # Coverage range 0–90 %; R/universal.R excluded
├── DESCRIPTION
├── NAMESPACE                 # Generated by roxygen2 – never edit manually
└── NEWS.md                   # User-facing changelog
```

---

## Coding Style

### Formatting
- **Indentation**: 2 spaces (set in `plot2.Rproj`; no tabs).
- **Line length**: keep readable; wrap long parameter lists with one argument per line.
- **Braces**: opening brace on the same line as the control structure or function header.

### Naming
| Kind | Convention | Example |
|---|---|---|
| Exported functions | `snake_case` | `plot2()`, `get_colour()`, `theme_minimal2()` |
| Internal helpers | `snake_case` (no prefix) | `like()`, `font_black()`, `group_sizes()` |
| S3 methods | `function.class` | `plot2.data.frame`, `format2.Date` |
| Package environment | `plot2_env` | `plot2_env$reg_cols` |
| Internal NSE columns | `_var_x`, `_var_y`, … | prefixed with `_` to avoid clashes |
| Options | `plot2.<name>` | `plot2.colour`, `plot2.font` |

### File Headers
Every `.R` source file starts with the same 73-character-wide box comment block:

```r
# ===================================================================== #
#  An R package for Fast 'ggplot2' Plotting:                            #
#  https://github.com/msberends/plot2                                   #
#                                                                       #
#  This R package is free software; you can freely use and distribute   #
#  it for both personal and commercial purposes under the terms of the  #
#  GNU General Public License version 2.0 (GNU GPL-2), as published by  #
#  the Free Software Foundation.                                        #
#                                                                       #
#  We created this package for both routine data analysis and academic  #
#  research and it was publicly released in the hope that it will be    #
#  useful, but it comes WITHOUT ANY WARRANTY OR LIABILITY.              #
# ===================================================================== #
```

New files **must** include this header verbatim at the top.

### Documentation (roxygen2)
- Markdown is enabled (`Roxygen: list(markdown = TRUE)` in DESCRIPTION).
- Use `[function()]`, `[pkg::function()]`, and `[topic]` links freely.
- Parameter lists for multi-possibility arguments use a bullet list under `@param`.
- Group related functions with `@rdname`.
- Every exported function must have a `@examples` block.
- Internal helpers use `@keywords internal` (no `@export`).
- Never edit `man/` or `NAMESPACE` by hand – always regenerate with `devtools::document()`.

```r
#' Short Title
#'
#' @description Full description. The [plot2()] function …
#'
#' @param .data Data to plot.
#' @param x One of:
#' - A single variable, e.g. `x = column1`
#' - A function, e.g. `x = format(date, "%Y")`
#'
#' @return A [`ggplot`][ggplot2::ggplot()] object.
#' @examples
#' iris |> plot2(Species)
#' @export
```

### Error / Warning Handling
- Always use `call. = FALSE`:

  ```r
  stop("message", call. = FALSE)
  warning("message", call. = FALSE)
  ```

- Use the package's own wrappers for user-facing messages:

  ```r
  plot2_message("ℹ informational text")   # coloured blue via crayon
  plot2_warning("! warning text")         # coloured yellow
  ```

### NSE (Non-Standard Evaluation)
- Internal temporary columns are prefixed with `_` (e.g., `_var_x`, `_var_category`).
- All such names are declared in `globalVariables()` inside `R/utils.R` to suppress R CMD check notes. Add new NSE names there when needed.

### Custom Operators (defined in `R/utils.R`)
| Operator | Purpose |
|---|---|
| `%like%` | Case-insensitive regex match (`grepl` wrapper) |
| `%unlike%` | Negated `%like%` |
| `%>%` | Re-exported pipe from dplyr |
| `%+replace%` | ggplot2 theme replacement (imported) |

---

## Testing

- Framework: **testthat** (edition 2, configured in DESCRIPTION).
- All tests live in `tests/testthat/test_plot2.R`.
- Every test block uses `skip_on_cran()` to skip slow tests on CRAN.
- The file defines local helper functions at the top:

  ```r
  get_mapping(plot)   # extract aesthetic mappings
  get_layers(plot)    # extract layer list
  get_labels(plot)    # extract labels
  get_data(plot)      # extract plot data
  get_range_x(plot)   # extract x-axis range
  get_range_y(plot)   # extract y-axis range
  ```

- All `plot2()` calls are expected to return an object with S3 class `"gg"`:

  ```r
  expect_s3_class(iris |> plot2(Species), "gg")
  ```

### Running Tests

```r
# In R
devtools::test()

# or via shell
Rscript -e "devtools::test()"
```

---

## CI / CD

The `check.yaml` workflow runs `R CMD check` on every push and PR, and daily at 01:00 UTC.

| OS | R versions |
|---|---|
| macOS latest | release |
| Windows latest | release |
| Ubuntu latest | devel, release, oldrel-1, oldrel-2, oldrel-3 |

- macOS additionally installs `proj` + `gdal` (required by the `sf` suggested dependency).
- Vignettes are built with `--compact-vignettes=gs+qpdf`.
- All dependency upgrades are applied (`upgrade: 'TRUE'`).

Code coverage is tracked via Codecov (`codecov.yml`); `R/universal.R` is excluded from coverage.

---

## Key Patterns

### S3 Dispatch
`plot2()` uses S3 dispatch to handle different input classes. The generic is in `R/plot2.R`; methods are in `R/plot2-methods.R`:

```
plot2.default      – numeric vectors
plot2.data.frame   – the primary method (most logic lives here)
plot2.matrix       – correlation matrices → heatmap
plot2.sf           – simple features / geographic data
plot2.freq         – cleaner::freq() tables
plot2.lm           – linear model objects
plot2.formula      – formula interface
```

### Colour S3 Class
`get_colour.R` defines a `colour` vctrs-compatible S3 class with methods for `as.character`, `print`, `c`, `rep`, `rev`, `unique`, and `vec_cast`. Users register project colours with `register_colour()` / `unregister_colour()`; they are stored in `plot2_env$reg_cols`.

### Parameter Grouping Convention
`plot2()` parameter names follow a consistent dot-namespacing pattern:

| Prefix | Controls |
|---|---|
| `x.` | x-axis settings (`x.title`, `x.sort`, `x.max_items`, …) |
| `y.` | y-axis settings (`y.title`, `y.transform`, `y.limits`, …) |
| `facet.` | facet settings (`facet.nrow`, `facet.position`, …) |
| `datalabels.` | data-label settings (`datalabels.size`, `datalabels.colour`, …) |
| `smooth.` | smoothing settings |
| `sankey.` | Sankey-specific settings |

### validate_*() Functions
All argument validation happens in dedicated `validate_*()` functions in `R/validate.R` (e.g., `validate_type()`, `validate_legend.position()`). Keep validation out of the main function body.

---

## Common Development Commands

```r
# Document (regenerates man/ and NAMESPACE)
devtools::document()

# Check package
devtools::check()

# Run tests only
devtools::test()

# Build and install locally
devtools::install()

# Build pkgdown site locally
pkgdown::build_site()

# Rebuild README from README.Rmd
devtools::build_readme()
```

> **Note**: `man/` and `NAMESPACE` are auto-generated – commit them after running `devtools::document()`, but never edit them directly.

---

## Adding New Plot Types

1. Add type aliases/detection in `R/validate.R` inside `validate_type()`.
2. Implement the geom layer in `R/plot2.R` (or a dedicated file like `R/back2back_plot.R` for complex types).
3. Register any new NSE column names in `globalVariables()` in `R/utils.R`.
4. Add `@importFrom` tags and re-run `devtools::document()`.
5. Write tests in `tests/testthat/test_plot2.R` with `skip_on_cran()`.
6. Document the new type in the `@param type` block in `R/plot2.R` and update `vignettes/supported_types.Rmd`.

---

## Versioning & Changelog

- Version scheme: `MAJOR.MINOR.PATCH.9XXX` (`.9xxx` = development build).
- Current version: `1.99.0.9028` (see `DESCRIPTION`).
- All user-visible changes go in `NEWS.md` under the next version heading.
- NEWS entries are plain bullets; no conventional-commits prefix required.
